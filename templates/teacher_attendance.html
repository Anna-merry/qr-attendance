<!-- templates/teacher_attendance.html -->
{% extends "base.html" %}

{% block title %}–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å ‚Äî QR-–°–∫–∞–Ω–µ—Ä{% endblock %}

{% block content %}
<div class="container">
    <div class="welcome-section">
        <h2>üìä –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h2>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
    </div>

    <div class="filters" style="display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;">
        <div>
            <label for="group-select">–ì—Ä—É–ø–ø–∞:</label>
            <select id="group-select" class="form-control" onchange="loadAttendance()">
                <option value="">‚Äî –í—Å–µ –≥—Ä—É–ø–ø—ã ‚Äî</option>
                {% for group in groups %}
                <option value="{{ group }}">{{ group }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="date-input">–î–∞—Ç–∞:</label>
            <input type="date" id="date-input" class="form-control" onchange="loadAttendance()">
        </div>
        <div style="align-self: flex-end;">
            <button id="export-btn" class="btn btn-success" onclick="exportToExcel()">
                üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
            </button>
        </div>
    </div>

    <div id="attendance-table-container">
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏ –¥–∞—Ç—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</p>
    </div>
</div>

<style>
.form-control {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
}
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }

.attendance-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.attendance-table th,
.attendance-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}
.attendance-table th {
    background: #f8f9fa;
    font-weight: 600;
}
.attendance-table tr:hover {
    background: #f9f9f9;
}
.status-present { color: #28a745; font-weight: bold; }
.status-absent { color: #dc3545; }
</style>

<script>
function setDefaultDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date-input').value = today;
}

async function loadAttendance() {
    const group = document.getElementById('group-select').value;
    const dateStr = document.getElementById('date-input').value;
    const container = document.getElementById('attendance-table-container');

    if (!dateStr) {
        container.innerHTML = '<p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É.</p>';
        return;
    }

    container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';

    try {
        const url = new URL('/api/teacher/attendance', window.location.origin);
        if (group) url.searchParams.append('group', group);
        url.searchParams.append('date', dateStr);

        const res = await fetch(url, { method: 'GET' });
        const data = await res.json();

        if (res.status !== 200) {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        }

        renderTable(data, group, dateStr);
    } catch (err) {
        container.innerHTML = `<p style="color: red;">‚ùå ${err.message}</p>`;
    }
}

function renderTable(data, group, dateStr) {
    const container = document.getElementById('attendance-table-container');

    if (!data.lessons || data.lessons.length === 0) {
        container.innerHTML = `<p>–ù–∞ ${dateStr} ${group ? `–¥–ª—è –≥—Ä—É–ø–ø—ã ${group}` : '–≤ –≤–∞—à–∏—Ö –≥—Ä—É–ø–ø–∞—Ö'} –∑–∞–Ω—è—Ç–∏–π –Ω–µ—Ç.</p>`;
        return;
    }

    let html = `<h3>–ó–∞–Ω—è—Ç–∏—è –Ω–∞ ${new Date(dateStr).toLocaleDateString('ru-RU')} ${
        group ? `(–≥—Ä—É–ø–ø–∞ ${group})` : ''
    }</h3>`;

    data.lessons.forEach(lesson => {
        html += `
            <h4 style="margin-top: 24px;">${lesson.subject} | ${lesson.time} | ${lesson.group_name}</h4>
            <table class="attendance-table">
                <thead>
                    <tr>
                        <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–í—Ä–µ–º—è –æ—Ç–º–µ—Ç–∫–∏</th>
                    </tr>
                </thead>
                <tbody>
        `;

        if (lesson.students.length === 0) {
            html += `<tr><td colspan="3">–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø–µ</td></tr>`;
        } else {
            lesson.students.forEach(student => {
                const status = student.attended ? '‚úÖ –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç' : '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
                const statusClass = student.attended ? 'status-present' : 'status-absent';
                const timestamp = student.timestamp ? new Date(student.timestamp).toLocaleTimeString('ru-RU') : '‚Äî';

                html += `
                    <tr>
                        <td>${student.name}</td>
                        <td class="${statusClass}">${status}</td>
                        <td>${timestamp}</td>
                    </tr>
                `;
            });
        }

        html += `</tbody></table>`;
    });

    container.innerHTML = html;
}

async function exportToExcel() {
    const group = document.getElementById('group-select').value;
    const dateStr = document.getElementById('date-input').value;

    if (!dateStr) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    try {
        const url = `/api/teacher/attendance/export?date=${encodeURIComponent(dateStr)}`;
        if (group) url += `&group=${encodeURIComponent(group)}`;

        const response = await fetch(url, {
            method: 'GET',
            headers: { 'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }
        });

        if (!response.ok) {
            const err = await response.json().catch(() => ({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' }));
            throw new Error(err.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å');
        }

        // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        const blob = await response.blob();
        const urlObj = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = urlObj;
        a.download = `–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å_${group || '–≤—Å–µ'}_${dateStr}.xlsx`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            window.URL.revokeObjectURL(urlObj);
            document.body.removeChild(a);
        }, 100);
    } catch (err) {
        alert(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${err.message}`);
        console.error(err);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    setDefaultDate();
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–≤—Å–µ –≥—Ä—É–ø–ø—ã, —Å–µ–≥–æ–¥–Ω—è)
    setTimeout(loadAttendance, 300);
});
</script>
{% endblock %}