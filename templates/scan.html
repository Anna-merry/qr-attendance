<!-- templates/scan.html -->
{% extends "base.html" %}

{% block title %}Сканировать QR-код — QR-Сканер{% endblock %}

{% block content %}
<div class="scan-container text-center" style="padding: 20px;">
    <h2>Наведите камеру на QR-код преподавателя</h2>
    <video id="video" width="100%" height="400" style="background: black; margin: 20px 0; border-radius: 8px;"></video>
    <p id="status">Ожидание QR-кода...</p>
    <button id="start-btn" class="btn btn-primary">Запустить камеру</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
let video;
let canvas;
let ctx;

async function startCamera() {
    const status = document.getElementById('status');
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment" } 
        });
        
        video = document.getElementById('video');
        video.srcObject = stream;

        // ✅ await video.play() + обработка ошибки
        try {
            await video.play();
        } catch (err) {
            console.warn("video.play() failed, but continuing...", err);
        }

        document.getElementById('start-btn').style.display = 'none';
        status.textContent = 'Ищу QR-код...';

        canvas = document.createElement('canvas');
        ctx = canvas.getContext('2d', { willReadFrequently: true });
        requestAnimationFrame(scanFrame);
    } catch (err) {
        status.textContent = 'Ошибка: камера не доступна';
        console.error('Camera error:', err);
    }
}

function scanFrame() {
    if (!video || !ctx || !video.srcObject) return;
    
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth || 300;
        canvas.height = video.videoHeight || 200;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height); // ← jsQR, не jsQR()
        
        if (code) {
            // ... ваша логика обработки QR ...
            console.log('✅ QR распознан:', code.data);
            // ... отправка ...
            return;
        }
    }
    requestAnimationFrame(scanFrame);
}

document.getElementById('start-btn').addEventListener('click', startCamera);

document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const item_id = urlParams.get('item_id');
    const date = urlParams.get('date');
    const token = urlParams.get('token');

    const statusEl = document.getElementById('status');

    // Если параметры есть — отправляем автоматически
    if (item_id && date && token) {
        statusEl.textContent = 'Автоматическая отправка...';
        fetch('/api/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id, date, token })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                statusEl.innerHTML = `<span style="color: green; font-size: 18px;">✅ ${data.message}</span>`;
            } else {
                statusEl.innerHTML = `<span style="color: red;">❌ ${data.message}</span>`;
            }
            // Остановить камеру, если она запущена
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
            }
        })
        .catch(err => {
            statusEl.textContent = '❌ Ошибка отправки';
            console.error(err);
        });

        // Скрываем камеру и кнопку
        document.getElementById('video').style.display = 'none';
        document.getElementById('start-btn').style.display = 'none';
    }
    // Если параметров нет — показываем камеру
    else {
        statusEl.textContent = 'Ожидание QR-кода...';
        // Кнопка "Запустить камеру" остаётся видимой
    }
});

</script>
{% endblock %}