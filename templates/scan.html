<!-- templates/scan.html -->
{% extends "base.html" %}

{% block title %}Сканировать QR-код — QR-Сканер{% endblock %}

{% block content %}
<div class="scan-container text-center" style="padding: 20px;">
    <h2>Наведите камеру на QR-код преподавателя</h2>
    <video id="video" width="100%" height="400" style="background: black; margin: 20px 0; border-radius: 8px;"></video>
    <p id="status">Ожидание QR-кода...</p>
    <button id="start-btn" class="btn btn-primary">Запустить камеру</button>
</div>

<script src="{{ url_for('static', filename='js/jsQR.min.js') }}"></script>
<script>
let video;
let canvas;
let ctx;

async function startCamera() {
    const status = document.getElementById('status');
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment" } 
        });
        
        video = document.getElementById('video');
        video.srcObject = stream;
        video.play();

        document.getElementById('start-btn').style.display = 'none';
        status.textContent = 'Ищу QR-код...';

        // Запуск распознавания
        canvas = document.createElement('canvas');
        ctx = canvas.getContext('2d', { willReadFrequently: true });
        requestAnimationFrame(scanFrame);
    } catch (err) {
        status.textContent = 'Ошибка: камера не доступна';
        console.error(err);
    }
}

function scanFrame() {
    if (!video || !ctx) return;
    
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
            try {
                const url = new URL(code.data);
                const clean = s => s ? s.trim().replace(/[\x00-\x1F\x7F]/g, '') : '';
                const item_id = clean(url.searchParams.get('item_id'));
                const date = clean(url.searchParams.get('date'));
                const token = clean(url.searchParams.get('token'));

                if (!item_id || !date || !token) {
                    throw new Error('Нет item_id/date/token');
                }

                document.getElementById('status').textContent = 'Отправка...';
                fetch('/api/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id, date, token })
                })
                .then(r => r.json())
                .then(data => {
                    const statusEl = document.getElementById('status');
                    if (data.status === 'success') {
                        statusEl.innerHTML = `<span style="color: green; font-size: 18px;"> ${data.message}</span>`;
                        // Останавливаем камеру
                        video.srcObject?.getTracks().forEach(t => t.stop());
                    } else {
                        statusEl.innerHTML = `<span style="color: red;"> ${data.message}</span>`;
                    }
                })
                .catch(err => {
                    document.getElementById('status').textContent = 'Ошибка отправки';
                    console.error(err);
                });
            } catch (e) {
                document.getElementById('status').textContent = 'Неверный QR-код';
                console.error('QR parse error:', e);
            }
            return;
        }
    }
    requestAnimationFrame(scanFrame);
}

// Запуск при клике
document.getElementById('start-btn').addEventListener('click', startCamera);


document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const item_id = urlParams.get('item_id');
    const date = urlParams.get('date');
    const token = urlParams.get('token');

    const statusEl = document.getElementById('status');

    // Если параметры есть — отправляем автоматически
    if (item_id && date && token) {
        statusEl.textContent = 'Автоматическая отправка...';
        fetch('/api/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id, date, token })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                statusEl.innerHTML = `<span style="color: green; font-size: 18px;">✅ ${data.message}</span>`;
            } else {
                statusEl.innerHTML = `<span style="color: red;">❌ ${data.message}</span>`;
            }
            // Остановить камеру, если она запущена
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
            }
        })
        .catch(err => {
            statusEl.textContent = '❌ Ошибка отправки';
            console.error(err);
        });

        // Скрываем камеру и кнопку
        document.getElementById('video').style.display = 'none';
        document.getElementById('start-btn').style.display = 'none';
    }
    // Если параметров нет — показываем камеру
    else {
        statusEl.textContent = 'Ожидание QR-кода...';
        // Кнопка "Запустить камеру" остаётся видимой
    }
});

</script>
{% endblock %}