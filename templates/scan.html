<!-- templates/scan.html -->
{% extends "base.html" %}

{% block title %}–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥ ‚Äî QR-–°–∫–∞–Ω–µ—Ä{% endblock %}

{% block content %}
<div class="scan-container text-center" style="padding: 20px;">
    <h2>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</h2>
    <video id="video" width="100%" height="400" style="background: black; margin: 20px 0; border-radius: 8px;"></video>
    <p id="status">–û–∂–∏–¥–∞–Ω–∏–µ QR-–∫–æ–¥–∞...</p>
    <button id="start-btn" class="btn btn-primary">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
</div>

<script src="{{ url_for('static', filename='js/jsQR.min.js') }}"></script>

<script>
let video;
let canvas;
let ctx;

async function startCamera() {
    const status = document.getElementById('status');
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment" } 
        });
        
        video = document.getElementById('video');
        video.srcObject = stream;

        // ‚úÖ await video.play() + –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
        try {
            await video.play();
        } catch (err) {
            console.warn("video.play() failed, but continuing...", err);
        }

        document.getElementById('start-btn').style.display = 'none';
        status.textContent = '–ò—â—É QR-–∫–æ–¥...';

        canvas = document.createElement('canvas');
        ctx = canvas.getContext('2d', { willReadFrequently: true });
        requestAnimationFrame(scanFrame);
    } catch (err) {
        status.textContent = '–û—à–∏–±–∫–∞: –∫–∞–º–µ—Ä–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞';
        console.error('Camera error:', err);
    }
}

function scanFrame() {
    if (!video || !ctx || !video.srcObject) return;
    
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth || 300;
        canvas.height = video.videoHeight || 200;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height); // ‚Üê jsQR, –Ω–µ jsQR()
        
        if (code) {
    try {
        // üîπ –ü–∞—Ä—Å–∏–º URL –Ω–∞–ø—Ä—è–º—É—é
        const url = new URL(code.data);
        const item_id = url.searchParams.get('item_id')?.trim();
        const date = url.searchParams.get('date')?.trim();
        const token = url.searchParams.get('token')?.trim();

        if (!item_id || !date || !token) {
            throw new Error('–ù–µ—Ç item_id/date/token');
        }

        // üîπ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –°–†–ê–ó–£
        document.getElementById('status').textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
        fetch('/api/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id, date, token })
        })
        .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
        })
        .then(data => {
            const statusEl = document.getElementById('status');
            if (data.status === 'success') {
                statusEl.innerHTML = `<span style="color: green; font-size: 18px;"> ${data.message}</span>`;
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
                video.srcObject?.getTracks().forEach(t => t.stop());
            } else {
                statusEl.innerHTML = `<span style="color: red;"> ${data.message}</span>`;
            }
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞:', err);
            document.getElementById('status').textContent = ` –û—à–∏–±–∫–∞: ${err.message}`;
        });

    } catch (e) {
        console.error('QR parse error:', e);
        document.getElementById('status').textContent = ' –ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥';
    }
    return;
}
    }
    requestAnimationFrame(scanFrame);
}

document.getElementById('start-btn').addEventListener('click', startCamera);

document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const item_id = urlParams.get('item_id');
    const date = urlParams.get('date');
    const token = urlParams.get('token');

    const statusEl = document.getElementById('status');

    // –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –µ—Å—Ç—å ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    if (item_id && date && token) {
        statusEl.textContent = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞...';
        fetch('/api/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id, date, token })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                statusEl.innerHTML = `<span style="color: green; font-size: 18px;">‚úÖ ${data.message}</span>`;
            } else {
                statusEl.innerHTML = `<span style="color: red;">‚ùå ${data.message}</span>`;
            }
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É, –µ—Å–ª–∏ –æ–Ω–∞ –∑–∞–ø—É—â–µ–Ω–∞
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
            }
        })
        .catch(err => {
            statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏';
            console.error(err);
        });

        // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É –∏ –∫–Ω–æ–ø–∫—É
        document.getElementById('video').style.display = 'none';
        document.getElementById('start-btn').style.display = 'none';
    }
    // –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É
    else {
        statusEl.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ QR-–∫–æ–¥–∞...';
        // –ö–Ω–æ–ø–∫–∞ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É" –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∏–¥–∏–º–æ–π
    }
});

</script>
{% endblock %}